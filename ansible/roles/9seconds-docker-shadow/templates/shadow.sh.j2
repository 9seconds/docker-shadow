#!/bin/bash
# vim: set ft=sh:
{{ ansible_managed | comment }}
set -eu -o pipefail

SS_SIMPLE_PORT=""
{% if shadowsocks_simple_port is defined %}
SS_SIMPLE_PORT="-p {{ shadowsocks_simple_port }}:443/tcp -p {{ shadowsocks_simple_port }}:/udp"
{% endif %}

SS_OBFS_PORT=""
{% if shadowsocks_obfs_port is defined %}
SS_OBFS_PORT="-p {{ shadowsocks_obfs_port }}:444/tcp -p {{ shadowsocks_obfs_port }}:444/udp"
{% endif %}

KCP_PORT=""
{% if kcptun_port is defined %}
KCP_PORT="-p {{ kcptun_port }}:445/udp"
{% endif %}

exec /usr/bin/docker run \
    --rm \
    --log-driver none \
    --name {{ container_name | quote }} \
    -v /etc/docker-shadow.json:/config.json:ro \
    {% for key, value in (shadowsocks_sysctl | dictsort) %}--sysctl {{
        "%s=%s" | format(key, value) | quote }} \
    {% endfor %} $SS_SIMPLE_PORT $SS_OBFS_PORT $KCP_PORT {{ docker_image | quote }}
